<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Survival_Analysis_Report | ylinJiang Space</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Big Data Analysis Software and Application (Hadoop or Spark) Project 1Q2 Survival AnalysisSurvival Analysis is a statistical approach used to analyze the time until an event of interest occurs. This e">
<meta property="og:type" content="article">
<meta property="og:title" content="Survival_Analysis_Report">
<meta property="og:url" content="http://example.com/2025/04/13/Survival-Analysis-Report/index.html">
<meta property="og:site_name" content="ylinJiang Space">
<meta property="og:description" content="Big Data Analysis Software and Application (Hadoop or Spark) Project 1Q2 Survival AnalysisSurvival Analysis is a statistical approach used to analyze the time until an event of interest occurs. This e">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_14_1.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_1.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_5.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_9.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_13.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_17.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_21.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_25.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_29.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_33.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_37.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_41.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_45.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_49.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_53.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_16_57.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/3e021aca-c693-4a98-b4ed-947b6d3e4bd5.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_25_3.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_25_4.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_25_5.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_27_5.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_27_6.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_27_7.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_27_8.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_29_0.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_29_1.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_29_2.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_29_3.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_29_4.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/97d18aa5-cabe-4736-9526-c05d1e10cc63.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_33_3.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_35_0.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_35_1.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_35_2.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_35_3.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_35_4.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_35_5.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_35_6.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_35_7.png">
<meta property="og:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_42_0.png">
<meta property="article:published_time" content="2025-04-12T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-13T18:15:19.102Z">
<meta property="article:author" content="ylinJiang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/04/12/hello-world/lysis-Report/output_14_1.png">
  
    <link rel="alternate" href="/atom.xml" title="ylinJiang Space" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ylinJiang Space</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">ylinJiang Space</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Survival-Analysis-Report" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/13/Survival-Analysis-Report/" class="article-date">
  <time class="dt-published" datetime="2025-04-12T16:00:00.000Z" itemprop="datePublished">2025-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Survival_Analysis_Report
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Big-Data-Analysis-Software-and-Application-Hadoop-or-Spark-Project-1"><a href="#Big-Data-Analysis-Software-and-Application-Hadoop-or-Spark-Project-1" class="headerlink" title="Big Data Analysis Software and Application (Hadoop or Spark) Project 1"></a>Big Data Analysis Software and Application (Hadoop or Spark) Project 1</h1><h3 id="Q2-Survival-Analysis"><a href="#Q2-Survival-Analysis" class="headerlink" title="Q2 Survival Analysis"></a>Q2 Survival Analysis</h3><p>Survival Analysis is a statistical approach used to analyze the time until an event of interest occurs. This event is often referred to as a “failure” or “event”, and it can represent various outcomes depending on the context, such as death, disease recurrence, equipment failure, or any other event that can be timed.</p>
<p><em>生存分析流程</em></p>
<p>1.数据预处理<br>提取出感兴趣的变量，独热编码</p>
<p>2.使用模型<br>(a)Model 1：Kaplan-Meier (non-parametric)：适用于单分类变量分析</p>
<p>(b)Model 2：The Cox Proportional Hazards(semi-parametric ):<br>适用范围广，单&#x2F;多变量、分类&#x2F;连续变量皆可（连续变量需先分段成分类变量）。<br>the proportional hazard assumption。（Do I need to care about the proportional hazard assumption?）</p>
<p>(c)Model 3：Accelerated Failure Time (fully parametric model)<br><code>assumptions</code>: the Proportional Odds assumption &amp; the outcome variable is assumed to follow a specified distribution<br>需要指定数据分布类型，可以绘制Log-Odds Kaplan-Meier Plots，检验模型的假设是否成立</p>
<p>3.预测&#x2F;summary</p>
<h4 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Load libraries</span></span><br><span class="line"><span class="keyword">import</span> pyspark</span><br><span class="line"><span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> SparkSession</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> col, when</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.types <span class="keyword">import</span> StructType,StructField,DoubleType, StringType, IntegerType</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download the Data</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">raw_path=<span class="string">&quot;https://raw.githubusercontent.com/IBM/telco-customer-churn-on-icp4d/master/data/Telco-Customer-Churn.csv&quot;</span></span><br><span class="line"><span class="comment">#将数据下载到本地</span></span><br><span class="line">local_dir=<span class="string">&quot;./Q2_data&quot;</span></span><br><span class="line">os.makedirs(local_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(raw_path)</span><br><span class="line">    response.raise_for_status()  <span class="comment"># 检查HTTP错误</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;<span class="subst">&#123;local_dir&#125;</span>/Telco-Customer-Churn.csv&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(response.content)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;文件已下载到：<span class="subst">&#123;local_dir&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;下载失败：<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<pre><code>文件已下载到：./Q2_data
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize Spark Session</span></span><br><span class="line">spark = SparkSession.builder.appName(<span class="string">&quot;Survival Analysis&quot;</span>).getOrCreate()</span><br></pre></td></tr></table></figure>

<pre><code>Setting default log level to &quot;WARN&quot;.
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
25/04/13 13:24:10 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
25/04/13 13:24:11 WARN Utils: Service &#39;SparkUI&#39; could not bind on port 4040. Attempting port 4041.
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看分析数据并定义schema</span></span><br><span class="line">schema = StructType([</span><br><span class="line">  StructField(<span class="string">&#x27;customerID&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;gender&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;seniorCitizen&#x27;</span>, DoubleType()),</span><br><span class="line">  StructField(<span class="string">&#x27;partner&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;dependents&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;tenure&#x27;</span>, DoubleType()),</span><br><span class="line">  StructField(<span class="string">&#x27;phoneService&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;multipleLines&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;internetService&#x27;</span>, StringType()), </span><br><span class="line">  StructField(<span class="string">&#x27;onlineSecurity&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;onlineBackup&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;deviceProtection&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;techSupport&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;streamingTV&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;streamingMovies&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;contract&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;paperlessBilling&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;paymentMethod&#x27;</span>, StringType()),</span><br><span class="line">  StructField(<span class="string">&#x27;monthlyCharges&#x27;</span>, DoubleType()),</span><br><span class="line">  StructField(<span class="string">&#x27;totalCharges&#x27;</span>, DoubleType()),</span><br><span class="line">  StructField(<span class="string">&#x27;churnString&#x27;</span>, StringType())</span><br><span class="line">  ])</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据预处理：导入与清洗,筛选出需要的数据</span></span><br><span class="line">bronze_df = spark.read.<span class="built_in">format</span>(<span class="string">&#x27;csv&#x27;</span>).schema(schema).option(<span class="string">&#x27;header&#x27;</span>,<span class="string">&#x27;true&#x27;</span>).load(<span class="string">&quot;./Q2_data/Telco-Customer-Churn.csv&quot;</span>)</span><br><span class="line">silver_df = bronze_df.withColumn(<span class="string">&#x27;churn&#x27;</span>,when(col(<span class="string">&#x27;churnString&#x27;</span>) == <span class="string">&#x27;Yes&#x27;</span>,<span class="number">1</span>).when(col(<span class="string">&#x27;churnString&#x27;</span>) == <span class="string">&#x27;No&#x27;</span>,<span class="number">0</span>).otherwise(<span class="string">&#x27;Unknown&#x27;</span>))\</span><br><span class="line">                     .drop(<span class="string">&#x27;churnString&#x27;</span>).<span class="built_in">filter</span>(col(<span class="string">&#x27;contract&#x27;</span>) == <span class="string">&#x27;Month-to-month&#x27;</span>)\</span><br><span class="line">                     .<span class="built_in">filter</span>(col(<span class="string">&#x27;internetService&#x27;</span>) != <span class="string">&#x27;No&#x27;</span>)</span><br><span class="line"><span class="comment">#查看清洗后的数据</span></span><br><span class="line">silver_df.printSchema()</span><br><span class="line">silver_df.show(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<pre><code>root
 |-- customerID: string (nullable = true)
 |-- gender: string (nullable = true)
 |-- seniorCitizen: double (nullable = true)
 |-- partner: string (nullable = true)
 |-- dependents: string (nullable = true)
 |-- tenure: double (nullable = true)
 |-- phoneService: string (nullable = true)
 |-- multipleLines: string (nullable = true)
 |-- internetService: string (nullable = true)
 |-- onlineSecurity: string (nullable = true)
 |-- onlineBackup: string (nullable = true)
 |-- deviceProtection: string (nullable = true)
 |-- techSupport: string (nullable = true)
 |-- streamingTV: string (nullable = true)
 |-- streamingMovies: string (nullable = true)
 |-- contract: string (nullable = true)
 |-- paperlessBilling: string (nullable = true)
 |-- paymentMethod: string (nullable = true)
 |-- monthlyCharges: double (nullable = true)
 |-- totalCharges: double (nullable = true)
 |-- churn: string (nullable = false)



25/04/13 13:24:22 WARN CSVHeaderChecker: CSV header does not conform to the schema.
 Header: customerID, gender, SeniorCitizen, Partner, Dependents, tenure, PhoneService, MultipleLines, InternetService, OnlineSecurity, OnlineBackup, DeviceProtection, TechSupport, StreamingTV, StreamingMovies, Contract, PaperlessBilling, PaymentMethod, MonthlyCharges, TotalCharges, Churn
 Schema: customerID, gender, seniorCitizen, partner, dependents, tenure, phoneService, multipleLines, internetService, onlineSecurity, onlineBackup, deviceProtection, techSupport, streamingTV, streamingMovies, contract, paperlessBilling, paymentMethod, monthlyCharges, totalCharges, churnString
Expected: churnString but found: Churn
CSV file: file:///data/lab/homework/project1/Q2_data/Telco-Customer-Churn.csv
                                                                                

+----------+------+-------------+-------+----------+------+------------+----------------+---------------+--------------+------------+----------------+-----------+-----------+---------------+--------------+----------------+--------------------+--------------+------------+-----+
|customerID|gender|seniorCitizen|partner|dependents|tenure|phoneService|   multipleLines|internetService|onlineSecurity|onlineBackup|deviceProtection|techSupport|streamingTV|streamingMovies|      contract|paperlessBilling|       paymentMethod|monthlyCharges|totalCharges|churn|
+----------+------+-------------+-------+----------+------+------------+----------------+---------------+--------------+------------+----------------+-----------+-----------+---------------+--------------+----------------+--------------------+--------------+------------+-----+
|7590-VHVEG|Female|          0.0|    Yes|        No|   1.0|          No|No phone service|            DSL|            No|         Yes|              No|         No|         No|             No|Month-to-month|             Yes|    Electronic check|         29.85|       29.85|    0|
|3668-QPYBK|  Male|          0.0|     No|        No|   2.0|         Yes|              No|            DSL|           Yes|         Yes|              No|         No|         No|             No|Month-to-month|             Yes|        Mailed check|         53.85|      108.15|    1|
|9237-HQITU|Female|          0.0|     No|        No|   2.0|         Yes|              No|    Fiber optic|            No|          No|              No|         No|         No|             No|Month-to-month|             Yes|    Electronic check|          70.7|      151.65|    1|
|9305-CDSKC|Female|          0.0|     No|        No|   8.0|         Yes|             Yes|    Fiber optic|            No|          No|             Yes|         No|        Yes|            Yes|Month-to-month|             Yes|    Electronic check|         99.65|       820.5|    1|
|1452-KIOVK|  Male|          0.0|     No|       Yes|  22.0|         Yes|             Yes|    Fiber optic|            No|         Yes|              No|         No|        Yes|             No|Month-to-month|             Yes|Credit card (auto...|          89.1|      1949.4|    0|
+----------+------+-------------+-------+----------+------+------------+----------------+---------------+--------------+------------+----------------+-----------+-----------+---------------+--------------+----------------+--------------------+--------------+------------+-----+
only showing top 5 rows
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Load the silver_df data</span></span><br><span class="line">telco_pd = silver_df.toPandas()</span><br><span class="line">telco_pd</span><br></pre></td></tr></table></figure>

<pre><code>25/04/13 13:24:23 WARN CSVHeaderChecker: CSV header does not conform to the schema.
 Header: customerID, gender, SeniorCitizen, Partner, Dependents, tenure, PhoneService, MultipleLines, InternetService, OnlineSecurity, OnlineBackup, DeviceProtection, TechSupport, StreamingTV, StreamingMovies, Contract, PaperlessBilling, PaymentMethod, MonthlyCharges, TotalCharges, Churn
 Schema: customerID, gender, seniorCitizen, partner, dependents, tenure, phoneService, multipleLines, internetService, onlineSecurity, onlineBackup, deviceProtection, techSupport, streamingTV, streamingMovies, contract, paperlessBilling, paymentMethod, monthlyCharges, totalCharges, churnString
Expected: churnString but found: Churn
CSV file: file:///data/lab/homework/project1/Q2_data/Telco-Customer-Churn.csv
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>seniorCitizen</th>
      <th>partner</th>
      <th>dependents</th>
      <th>tenure</th>
      <th>phoneService</th>
      <th>multipleLines</th>
      <th>internetService</th>
      <th>onlineSecurity</th>
      <th>...</th>
      <th>deviceProtection</th>
      <th>techSupport</th>
      <th>streamingTV</th>
      <th>streamingMovies</th>
      <th>contract</th>
      <th>paperlessBilling</th>
      <th>paymentMethod</th>
      <th>monthlyCharges</th>
      <th>totalCharges</th>
      <th>churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7590-VHVEG</td>
      <td>Female</td>
      <td>0.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>1.0</td>
      <td>No</td>
      <td>No phone service</td>
      <td>DSL</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>29.85</td>
      <td>29.85</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3668-QPYBK</td>
      <td>Male</td>
      <td>0.0</td>
      <td>No</td>
      <td>No</td>
      <td>2.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>DSL</td>
      <td>Yes</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Mailed check</td>
      <td>53.85</td>
      <td>108.15</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9237-HQITU</td>
      <td>Female</td>
      <td>0.0</td>
      <td>No</td>
      <td>No</td>
      <td>2.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>70.70</td>
      <td>151.65</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9305-CDSKC</td>
      <td>Female</td>
      <td>0.0</td>
      <td>No</td>
      <td>No</td>
      <td>8.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>Yes</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>99.65</td>
      <td>820.50</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1452-KIOVK</td>
      <td>Male</td>
      <td>0.0</td>
      <td>No</td>
      <td>Yes</td>
      <td>22.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Credit card (automatic)</td>
      <td>89.10</td>
      <td>1949.40</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3346</th>
      <td>9767-FFLEM</td>
      <td>Male</td>
      <td>0.0</td>
      <td>No</td>
      <td>No</td>
      <td>38.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Credit card (automatic)</td>
      <td>69.50</td>
      <td>2625.25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3347</th>
      <td>0639-TSIQW</td>
      <td>Female</td>
      <td>0.0</td>
      <td>No</td>
      <td>No</td>
      <td>67.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>Yes</td>
      <td>...</td>
      <td>Yes</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Credit card (automatic)</td>
      <td>102.95</td>
      <td>6886.25</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3348</th>
      <td>8456-QDAVC</td>
      <td>Male</td>
      <td>0.0</td>
      <td>No</td>
      <td>No</td>
      <td>19.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Bank transfer (automatic)</td>
      <td>78.70</td>
      <td>1495.10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3349</th>
      <td>4801-JZAZL</td>
      <td>Female</td>
      <td>0.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>11.0</td>
      <td>No</td>
      <td>No phone service</td>
      <td>DSL</td>
      <td>Yes</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>29.60</td>
      <td>346.45</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3350</th>
      <td>8361-LTMKD</td>
      <td>Male</td>
      <td>1.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>4.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Mailed check</td>
      <td>74.40</td>
      <td>306.60</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>3351 rows × 21 columns</p>
</div>



<h4 id="Model-1：Kaplan-Meier-non-parametric"><a href="#Model-1：Kaplan-Meier-non-parametric" class="headerlink" title="Model 1：Kaplan-Meier (non-parametric)"></a>Model 1：Kaplan-Meier (non-parametric)</h4><p>1.绘制生存曲线&amp;计算中位生存时间</p>
<p>2.单因素生存分析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!pip install lifelines</span></span><br><span class="line"><span class="comment"># 卸载冲突包</span></span><br><span class="line"><span class="comment">#!pip uninstall -y numpy scipy lifelines autograd</span></span><br><span class="line"><span class="comment"># 清除所有缓存（关键步骤！）</span></span><br><span class="line"><span class="comment">#!pip cache purge</span></span><br><span class="line"><span class="comment"># 安装兼容版本组合</span></span><br><span class="line"><span class="comment">#!pip install &quot;numpy==1.21.5&quot; &quot;scipy==1.7.3&quot; &quot;lifelines==0.27.7&quot;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import libraries</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> lifelines <span class="keyword">import</span> KaplanMeierFitter</span><br><span class="line"><span class="keyword">from</span> lifelines.utils <span class="keyword">import</span> median_survival_times</span><br><span class="line"><span class="keyword">from</span> lifelines.statistics <span class="keyword">import</span> pairwise_logrank_test</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 1.创建Kaplan-Meier模型，并绘制Population-Level生存曲线和计算中位生存时间</span></span><br><span class="line">kmf = KaplanMeierFitter()</span><br><span class="line">T=telco_pd[<span class="string">&#x27;tenure&#x27;</span>]</span><br><span class="line">C=telco_pd[<span class="string">&#x27;churn&#x27;</span>].astype(<span class="built_in">float</span>)</span><br><span class="line"><span class="comment">#拟合Kaplan-Meier生存曲线</span></span><br><span class="line">kmf.fit(durations=T,event_observed=C)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制生存曲线</span></span><br><span class="line">kmf.plot_survival_function(at_risk_counts=<span class="literal">True</span>)<span class="comment">#kmf.plot(title=&#x27;Kaplan-Meier Survival Curve: Population level&#x27;)</span></span><br><span class="line">plt.title(<span class="string">&quot;Kaplan-Meier Survival Curve: Population level&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;中位生存时间: &quot;</span>,kmf.median_survival_time_)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;生成概率:\n&quot;</span>,kmf.survival_function_)</span><br></pre></td></tr></table></figure>

<pre><code>中位生存时间:  34.0
生成概率:
           KM_estimate
timeline             
0.0          1.000000
1.0          0.903909
2.0          0.867517
3.0          0.839408
4.0          0.813474
...               ...
68.0         0.197268
69.0         0.162456
70.0         0.147688
71.0         0.126589
72.0         0.126589

[73 rows x 1 columns]
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_14_1.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 2.对分类变量进行分组，进行单因素生存分析，比较组之间的生存差异</span></span><br><span class="line"><span class="comment">#Define Helper function for plotting Kaplan-Meier curves at the covariate level</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plot_km</span>(<span class="params">col</span>):</span><br><span class="line">    fig,ax = plt.subplots()</span><br><span class="line">    <span class="comment">#根据col列分组</span></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> telco_pd[col].unique():</span><br><span class="line">        <span class="comment">#筛选出当前组的数据</span></span><br><span class="line">        ix = telco_pd[col] == r</span><br><span class="line">        kmf.fit(T[ix], C[ix],label=r)</span><br><span class="line">        kmf.plot(ax=ax)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;r&#125;</span>组的中位生存时间: &quot;</span>,kmf.median_survival_time_)</span><br><span class="line">    ax.set_title(<span class="string">f&#x27;Kaplan-Meier Survival Curve: <span class="subst">&#123;col&#125;</span>&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line">    </span><br><span class="line"><span class="comment">#Define Helper function for printing out Log-rank test results</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_logrank</span>(<span class="params">col</span>):</span><br><span class="line">    log_rank = pairwise_logrank_test(telco_pd[<span class="string">&#x27;tenure&#x27;</span>], telco_pd[col], telco_pd[<span class="string">&#x27;churn&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> log_rank.summary</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 列出感兴趣的分类变量，依次分析（绘制生存曲线、Log-rank test）</span></span><br><span class="line">interest_categoricals=[<span class="string">&#x27;gender&#x27;</span>,<span class="string">&#x27;seniorCitizen&#x27;</span>,<span class="string">&#x27;partner&#x27;</span>,<span class="string">&#x27;dependents&#x27;</span>,<span class="string">&#x27;phoneService&#x27;</span>,<span class="string">&#x27;multipleLines&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;internetService&#x27;</span>,<span class="string">&#x27;streamingTV&#x27;</span>,<span class="string">&#x27;streamingMovies&#x27;</span>,<span class="string">&#x27;onlineSecurity&#x27;</span>,<span class="string">&#x27;onlineBackup&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;deviceProtection&#x27;</span>,<span class="string">&#x27;techSupport&#x27;</span>,<span class="string">&#x27;paperlessBilling&#x27;</span>,<span class="string">&#x27;paymentMethod&#x27;</span>]</span><br><span class="line"><span class="comment">#找出组间有显著差异的分类变量，这些变量对预测有重要作用</span></span><br><span class="line">statistical_categorical=[]</span><br><span class="line"><span class="keyword">for</span> categorical <span class="keyword">in</span> interest_categoricals:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;~~~~~~~~~~~~~~~~~~~~for <span class="subst">&#123;categorical&#125;</span>~~~~~~~~~~~~~~~~~~~~~~~~&quot;</span>)</span><br><span class="line">    plot_km(categorical)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Log-rank test results&quot;</span>)</span><br><span class="line">    <span class="comment">#输出Log-rank test的结果</span></span><br><span class="line">    logrank_result=pairwise_logrank_test(telco_pd[<span class="string">&#x27;tenure&#x27;</span>], telco_pd[categorical], telco_pd[<span class="string">&#x27;churn&#x27;</span>])</span><br><span class="line">    logrank_result.print_summary()</span><br><span class="line">    <span class="comment">#logrank_result=print_logrank(categorical)</span></span><br><span class="line">    <span class="comment">#print(logrank_result,&quot;\n&quot;)</span></span><br><span class="line">    <span class="comment"># 根据p值判断Log-rank test结果，输出结论</span></span><br><span class="line">    <span class="keyword">if</span> logrank_result.summary[<span class="string">&#x27;p&#x27;</span>].<span class="built_in">min</span>()&gt;<span class="number">0.05</span>:<span class="comment">#多组间两两比较，只要有一对有显著差异，则该变量显著</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nCannot reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for <span class="subst">&#123;categorical&#125;</span> is greater than 0.05.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        statistical_categorical.append(categorical)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nReject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for <span class="subst">&#123;categorical&#125;</span> is not greater than 0.05.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出显著变量</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nStatistical categoricals:\n&quot;</span>,statistical_categorical)</span><br></pre></td></tr></table></figure>

<pre><code>~~~~~~~~~~~~~~~~~~~~for gender~~~~~~~~~~~~~~~~~~~~~~~~
Female组的中位生存时间:  32.0
Male组的中位生存时间:  36.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_1.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Female</th>
      <th>Male</th>
      <td>1.61</td>
      <td>0.20</td>
      <td>2.29</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Cannot reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for gender is greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for seniorCitizen~~~~~~~~~~~~~~~~~~~~~~~~
0.0组的中位生存时间:  35.0
1.0组的中位生存时间:  32.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_5.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0</th>
      <th>1.0</th>
      <td>49.03</td>
      <td>&lt;0.005</td>
      <td>38.53</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for seniorCitizen is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for partner~~~~~~~~~~~~~~~~~~~~~~~~
Yes组的中位生存时间:  49.0
No组的中位生存时间:  24.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_9.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>257.84</td>
      <td>&lt;0.005</td>
      <td>190.33</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for partner is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for dependents~~~~~~~~~~~~~~~~~~~~~~~~
No组的中位生存时间:  31.0
Yes组的中位生存时间:  49.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_13.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>13.41</td>
      <td>&lt;0.005</td>
      <td>11.96</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for dependents is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for phoneService~~~~~~~~~~~~~~~~~~~~~~~~
No组的中位生存时间:  40.0
Yes组的中位生存时间:  33.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_17.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>0.78</td>
      <td>0.38</td>
      <td>1.41</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Cannot reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for phoneService is greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for multipleLines~~~~~~~~~~~~~~~~~~~~~~~~
No phone service组的中位生存时间:  40.0
No组的中位生存时间:  23.0
Yes组的中位生存时间:  40.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_21.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">No</th>
      <th>No phone service</th>
      <td>35.55</td>
      <td>&lt;0.005</td>
      <td>28.58</td>
    </tr>
    <tr>
      <th>Yes</th>
      <td>411.23</td>
      <td>&lt;0.005</td>
      <td>301.31</td>
    </tr>
    <tr>
      <th>No phone service</th>
      <th>Yes</th>
      <td>44.06</td>
      <td>&lt;0.005</td>
      <td>34.87</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for multipleLines is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for internetService~~~~~~~~~~~~~~~~~~~~~~~~
DSL组的中位生存时间:  52.0
Fiber optic组的中位生存时间:  30.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_25.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>DSL</th>
      <th>Fiber optic</th>
      <td>85.46</td>
      <td>&lt;0.005</td>
      <td>65.19</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for internetService is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for streamingTV~~~~~~~~~~~~~~~~~~~~~~~~
No组的中位生存时间:  31.0
Yes组的中位生存时间:  39.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_29.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>140.76</td>
      <td>&lt;0.005</td>
      <td>105.44</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for streamingTV is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for streamingMovies~~~~~~~~~~~~~~~~~~~~~~~~
No组的中位生存时间:  31.0
Yes组的中位生存时间:  37.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_33.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>170.26</td>
      <td>&lt;0.005</td>
      <td>126.86</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for streamingMovies is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for onlineSecurity~~~~~~~~~~~~~~~~~~~~~~~~
No组的中位生存时间:  27.0
Yes组的中位生存时间:  63.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_37.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>75.80</td>
      <td>&lt;0.005</td>
      <td>58.14</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for onlineSecurity is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for onlineBackup~~~~~~~~~~~~~~~~~~~~~~~~
Yes组的中位生存时间:  54.0
No组的中位生存时间:  23.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_41.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>300.46</td>
      <td>&lt;0.005</td>
      <td>221.18</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for onlineBackup is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for deviceProtection~~~~~~~~~~~~~~~~~~~~~~~~
No组的中位生存时间:  27.0
Yes组的中位生存时间:  47.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_45.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>169.87</td>
      <td>&lt;0.005</td>
      <td>126.57</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for deviceProtection is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for techSupport~~~~~~~~~~~~~~~~~~~~~~~~
No组的中位生存时间:  29.0
Yes组的中位生存时间:  56.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_49.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>25.97</td>
      <td>&lt;0.005</td>
      <td>21.46</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for techSupport is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for paperlessBilling~~~~~~~~~~~~~~~~~~~~~~~~
Yes组的中位生存时间:  31.0
No组的中位生存时间:  43.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_53.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>No</th>
      <th>Yes</th>
      <td>25.26</td>
      <td>&lt;0.005</td>
      <td>20.93</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for paperlessBilling is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~for paymentMethod~~~~~~~~~~~~~~~~~~~~~~~~
Electronic check组的中位生存时间:  24.0
Mailed check组的中位生存时间:  30.0
Credit card (automatic)组的中位生存时间:  50.0
Bank transfer (automatic)组的中位生存时间:  51.0
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_16_57.png" alt="png"></p>
<pre><code>Log-rank test results
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>t_0</th>
      <td>-1</td>
    </tr>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>logrank_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">Bank transfer (automatic)</th>
      <th>Credit card (automatic)</th>
      <td>0.15</td>
      <td>0.70</td>
      <td>0.52</td>
    </tr>
    <tr>
      <th>Electronic check</th>
      <td>55.16</td>
      <td>&lt;0.005</td>
      <td>43.04</td>
    </tr>
    <tr>
      <th>Mailed check</th>
      <td>190.00</td>
      <td>&lt;0.005</td>
      <td>141.17</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Credit card (automatic)</th>
      <th>Electronic check</th>
      <td>45.17</td>
      <td>&lt;0.005</td>
      <td>35.69</td>
    </tr>
    <tr>
      <th>Mailed check</th>
      <td>165.36</td>
      <td>&lt;0.005</td>
      <td>123.30</td>
    </tr>
    <tr>
      <th>Electronic check</th>
      <th>Mailed check</th>
      <td>72.32</td>
      <td>&lt;0.005</td>
      <td>55.60</td>
    </tr>
  </tbody>
</table>


    
<pre><code>Reject the null hypothesis that the groups are statistically equivalent since the p-value in log-rank test for paymentMethod is not greater than 0.05.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Statistical categoricals:
 [&#39;seniorCitizen&#39;, &#39;partner&#39;, &#39;dependents&#39;, &#39;multipleLines&#39;, &#39;internetService&#39;, &#39;streamingTV&#39;, &#39;streamingMovies&#39;, &#39;onlineSecurity&#39;, &#39;onlineBackup&#39;, &#39;deviceProtection&#39;, &#39;techSupport&#39;, &#39;paperlessBilling&#39;, &#39;paymentMethod&#39;]
</code></pre>
<p><code>Summary:</code> 在所有感兴趣的分类变量中，只有<code>gender</code>与<code>phoneService</code>不显著，即在统计上这两个分类变量组间没有差异（alpha&#x3D;0.05），这表示这两个分类变量在用于预测时可能没有贡献。其中<code>phoneService</code>的log-rank test结果与<code>multipleLines</code>的log-rank test结果不同，而<code>multipleLines</code>包含了<code>phoneService</code>的信息（<code>multipleLines</code>的No phone service即<code>phoneService</code>的No），表明<code>multipleLines</code>更适合用于预测。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># or like the notebook</span></span><br><span class="line">plot_km(<span class="string">&#x27;gender&#x27;</span>)</span><br><span class="line">print_logrank(<span class="string">&#x27;gender&#x27;</span>)</span><br><span class="line"><span class="comment">#the p-value in log-rank test for Gender is greater than 0.05 ,therefore, </span></span><br><span class="line"><span class="comment">#we cannot reject the null hypothesis that the two groups are statistically equivalent.</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Extract survival probabilities(以internetService = DSL数据为例)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_survival_probs</span>(<span class="params">col,val</span>):</span><br><span class="line">    <span class="comment">#分组，拟合Kaplan-Meier生存曲线</span></span><br><span class="line">    ix = telco_pd[col] == val</span><br><span class="line">    <span class="keyword">return</span> kmf.fit(T[ix],C[ix],label=val) </span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract survival probabilities for customers with internetService = DSL </span></span><br><span class="line">sp_internet_dsl = get_survival_probs(<span class="string">&#x27;internetService&#x27;</span>,<span class="string">&#x27;DSL&#x27;</span>)</span><br><span class="line">pd.DataFrame(sp_internet_dsl.survival_function_at_times(<span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>)))</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>DSL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.902698</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.864380</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.834702</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.810522</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.794352</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.783900</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.776362</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.768486</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.750833</td>
    </tr>
  </tbody>
</table>
</div>



<p>After you complete your analysis, you can extract the survival probabilities to use for another application. </p>
<p>Kaplan-Meier is extremely useful for univariate analysis as it helps establish more intuition for the data at hand.</p>
<h4 id="Model-2：The-Cox-Proportional-Hazards-semi-parametric"><a href="#Model-2：The-Cox-Proportional-Hazards-semi-parametric" class="headerlink" title="Model 2：The Cox Proportional Hazards(semi-parametric )"></a>Model 2：The Cox Proportional Hazards(semi-parametric )</h4><p>The Cox Proportional Hazard equation: Baseline hazard is a function of time t, but not the parameters, whereas the partial hazard is a function of the parameters, but not time.<br><img src="/2025/04/12/hello-world/lysis-Report/3e021aca-c693-4a98-b4ed-947b6d3e4bd5.png" alt="image.png"></p>
<p>The Proportional Hazards Assumption: The hazard ratio between two groups is proportional over time.（变量不是随时间变化而变化的）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!pip install seaborn</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 筛选出感兴趣的数据并进行独热编码</span></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">from</span> lifelines.fitters.coxph_fitter <span class="keyword">import</span> CoxPHFitter</span><br><span class="line"><span class="keyword">from</span> lifelines.statistics <span class="keyword">import</span> proportional_hazard_test</span><br><span class="line"><span class="comment"># One-Hot Encode the Categorical Variables of interest</span></span><br><span class="line">encode_cols = [<span class="string">&#x27;dependents&#x27;</span>,<span class="string">&#x27;internetService&#x27;</span>,<span class="string">&#x27;onlineBackup&#x27;</span>,<span class="string">&#x27;techSupport&#x27;</span>,<span class="string">&#x27;paperlessBilling&#x27;</span>]</span><br><span class="line"> </span><br><span class="line">encoded_pd = pd.get_dummies(telco_pd,</span><br><span class="line">               columns=encode_cols,</span><br><span class="line">               prefix=encode_cols,</span><br><span class="line">               drop_first=<span class="literal">False</span>)</span><br><span class="line"> </span><br><span class="line">encoded_pd.head()</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>seniorCitizen</th>
      <th>partner</th>
      <th>tenure</th>
      <th>phoneService</th>
      <th>multipleLines</th>
      <th>onlineSecurity</th>
      <th>deviceProtection</th>
      <th>streamingTV</th>
      <th>...</th>
      <th>dependents_No</th>
      <th>dependents_Yes</th>
      <th>internetService_DSL</th>
      <th>internetService_Fiber optic</th>
      <th>onlineBackup_No</th>
      <th>onlineBackup_Yes</th>
      <th>techSupport_No</th>
      <th>techSupport_Yes</th>
      <th>paperlessBilling_No</th>
      <th>paperlessBilling_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7590-VHVEG</td>
      <td>Female</td>
      <td>0.0</td>
      <td>Yes</td>
      <td>1.0</td>
      <td>No</td>
      <td>No phone service</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>...</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3668-QPYBK</td>
      <td>Male</td>
      <td>0.0</td>
      <td>No</td>
      <td>2.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>...</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9237-HQITU</td>
      <td>Female</td>
      <td>0.0</td>
      <td>No</td>
      <td>2.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>...</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9305-CDSKC</td>
      <td>Female</td>
      <td>0.0</td>
      <td>No</td>
      <td>8.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>...</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1452-KIOVK</td>
      <td>Male</td>
      <td>0.0</td>
      <td>No</td>
      <td>22.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>...</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26 columns</p>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create new dataframe consisting of only the variables needed to fit the model</span></span><br><span class="line">survival_pd = encoded_pd[[<span class="string">&#x27;churn&#x27;</span>,<span class="string">&#x27;tenure&#x27;</span>,<span class="string">&#x27;dependents_Yes&#x27;</span>,<span class="string">&#x27;internetService_DSL&#x27;</span>,<span class="string">&#x27;onlineBackup_Yes&#x27;</span>,<span class="string">&#x27;techSupport_Yes&#x27;</span>]]</span><br><span class="line"><span class="comment"># Cast churn column as a float</span></span><br><span class="line">survival_pd.loc[:,<span class="string">&#x27;churn&#x27;</span>] = survival_pd.loc[:,<span class="string">&#x27;churn&#x27;</span>].astype(<span class="string">&#x27;float&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Fit the Cox Proportional Hazards Model(多变量分析)</span></span><br><span class="line"><span class="comment">#创建Cox回归模型</span></span><br><span class="line">cph = CoxPHFitter(alpha=<span class="number">0.05</span>)</span><br><span class="line"><span class="comment">#可以通过参数formula=&#x27;dependents_Yes+internetService_DSL&#x27;，传入部分变量</span></span><br><span class="line">cph.fit(survival_pd, <span class="string">&#x27;tenure&#x27;</span>, <span class="string">&#x27;churn&#x27;</span>)<span class="comment">#formula=‘dependents_Yes’为对dependents_Yes单变量分析</span></span><br><span class="line"><span class="comment">#Assess the Results of the Fitted Model</span></span><br><span class="line">cph.print_summary()</span><br><span class="line"><span class="comment">#画出每个变量的HR值和95%置信度区间（森林图)</span></span><br><span class="line">cph.plot(hazard_ratios=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#绘制生存曲线S(t)</span></span><br><span class="line">cph.baseline_survival_.plot()</span><br><span class="line">plt.title(<span class="string">&quot;Survival Curve&quot;</span>)</span><br><span class="line"><span class="comment">#绘制每个时间点对应的风险函数h(t)</span></span><br><span class="line">cph.baseline_hazard_.plot()</span><br><span class="line">plt.title(<span class="string">&quot;Baseline hazard&quot;</span>)</span><br><span class="line"><span class="comment">#若将数据划分为训练集与测试集，</span></span><br><span class="line"><span class="comment">#可以通过cph.predict_survival_function()预测个体的生存函数</span></span><br></pre></td></tr></table></figure>

<pre><code>/usr/local/lib/python3.10/dist-packages/lifelines/utils/__init__.py:1187: UserWarning: Attempting to convert an unexpected datatype &#39;object&#39; to float. Suggestion: 1) use `lifelines.utils.datetimes_to_durations` to do conversions or 2) manually convert to floats/booleans.
  warnings.warn(warning_text, UserWarning)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>model</th>
      <td>lifelines.CoxPHFitter</td>
    </tr>
    <tr>
      <th>duration col</th>
      <td>'tenure'</td>
    </tr>
    <tr>
      <th>event col</th>
      <td>'churn'</td>
    </tr>
    <tr>
      <th>baseline estimation</th>
      <td>breslow</td>
    </tr>
    <tr>
      <th>number of observations</th>
      <td>3351</td>
    </tr>
    <tr>
      <th>number of events observed</th>
      <td>1556</td>
    </tr>
    <tr>
      <th>partial log-likelihood</th>
      <td>-11315.95</td>
    </tr>
    <tr>
      <th>time fit was run</th>
      <td>2025-04-13 13:25:07 UTC</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th style="min-width: 12px;"></th>
      <th style="min-width: 12px;">coef</th>
      <th style="min-width: 12px;">exp(coef)</th>
      <th style="min-width: 12px;">se(coef)</th>
      <th style="min-width: 12px;">coef lower 95%</th>
      <th style="min-width: 12px;">coef upper 95%</th>
      <th style="min-width: 12px;">exp(coef) lower 95%</th>
      <th style="min-width: 12px;">exp(coef) upper 95%</th>
      <th style="min-width: 12px;">cmp to</th>
      <th style="min-width: 12px;">z</th>
      <th style="min-width: 12px;">p</th>
      <th style="min-width: 12px;">-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dependents_Yes</th>
      <td>-0.33</td>
      <td>0.72</td>
      <td>0.07</td>
      <td>-0.47</td>
      <td>-0.19</td>
      <td>0.63</td>
      <td>0.83</td>
      <td>0.00</td>
      <td>-4.64</td>
      <td>&lt;0.005</td>
      <td>18.12</td>
    </tr>
    <tr>
      <th>internetService_DSL</th>
      <td>-0.22</td>
      <td>0.80</td>
      <td>0.06</td>
      <td>-0.33</td>
      <td>-0.10</td>
      <td>0.72</td>
      <td>0.90</td>
      <td>0.00</td>
      <td>-3.68</td>
      <td>&lt;0.005</td>
      <td>12.07</td>
    </tr>
    <tr>
      <th>onlineBackup_Yes</th>
      <td>-0.78</td>
      <td>0.46</td>
      <td>0.06</td>
      <td>-0.89</td>
      <td>-0.66</td>
      <td>0.41</td>
      <td>0.52</td>
      <td>0.00</td>
      <td>-13.13</td>
      <td>&lt;0.005</td>
      <td>128.37</td>
    </tr>
    <tr>
      <th>techSupport_Yes</th>
      <td>-0.64</td>
      <td>0.53</td>
      <td>0.08</td>
      <td>-0.79</td>
      <td>-0.49</td>
      <td>0.46</td>
      <td>0.61</td>
      <td>0.00</td>
      <td>-8.48</td>
      <td>&lt;0.005</td>
      <td>55.36</td>
    </tr>
  </tbody>
</table><br><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>Concordance</th>
      <td>0.64</td>
    </tr>
    <tr>
      <th>Partial AIC</th>
      <td>22639.90</td>
    </tr>
    <tr>
      <th>log-likelihood ratio test</th>
      <td>337.77 on 4 df</td>
    </tr>
    <tr>
      <th>-log2(p) of ll-ratio test</th>
      <td>236.24</td>
    </tr>
  </tbody>
</table>
</div>





<pre><code>Text(0.5, 1.0, &#39;Baseline hazard&#39;)
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_25_3.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_25_4.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_25_5.png" alt="png"></p>
<p>协变量的95%置信度区间跨过横坐标轴上1的协变量的p值都是大于0.05的，由图可知，所选的变量都是显著的，若有不显著的变量，可以将其删除后重新拟合cox模型。</p>
<p>Verify if the Model Adheres to the Proportional Hazard Assumption</p>
<p>Method 1: Statistical Test</p>
<p>Method 2: Schoenfield Residuals Plots</p>
<p>Method 3: Log-log Kaplan-Meier Plots</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Method 1: Statistical Test &amp; Method 2: Schoenfeld Residuals Plots</span></span><br><span class="line">cph.check_assumptions(survival_pd,p_value_threshold=<span class="number">0.05</span>,show_plots=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/usr/local/lib/python3.10/dist-packages/lifelines/utils/__init__.py:1187: UserWarning: Attempting to convert an unexpected datatype &#39;object&#39; to float. Suggestion: 1) use `lifelines.utils.datetimes_to_durations` to do conversions or 2) manually convert to floats/booleans.
  warnings.warn(warning_text, UserWarning)



   Bootstrapping lowess lines. May take a moment...


   Bootstrapping lowess lines. May take a moment...

The ``p_value_threshold`` is set at 0.05. Even under the null hypothesis of no violations, some
covariates will be below the threshold by chance. This is compounded when there are many covariates.
Similarly, when there are lots of observations, even minor deviances from the proportional hazard
assumption will be flagged.

With that in mind, it&#39;s best to use a combination of statistical tests and visual tests to determine
the most serious violations. Produce visual plots using ``check_assumptions(..., show_plots=True)``
and looking for non-constant lines. See link [A] below for a full example.
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>model</th>
      <td>&lt;lifelines.CoxPHFitter: fitted with 3351 total...</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>proportional_hazard_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">dependents_Yes</th>
      <th>km</th>
      <td>1.48</td>
      <td>0.22</td>
      <td>2.16</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.81</td>
      <td>0.37</td>
      <td>1.44</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">internetService_DSL</th>
      <th>km</th>
      <td>20.98</td>
      <td>&lt;0.005</td>
      <td>17.72</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>26.71</td>
      <td>&lt;0.005</td>
      <td>22.01</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">onlineBackup_Yes</th>
      <th>km</th>
      <td>17.80</td>
      <td>&lt;0.005</td>
      <td>15.31</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>17.47</td>
      <td>&lt;0.005</td>
      <td>15.07</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">techSupport_Yes</th>
      <th>km</th>
      <td>8.09</td>
      <td>&lt;0.005</td>
      <td>7.81</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>13.76</td>
      <td>&lt;0.005</td>
      <td>12.23</td>
    </tr>
  </tbody>
</table>


    
    
<pre><code>1. Variable &#39;internetService_DSL&#39; failed the non-proportional test: p-value is &lt;5e-05.

   Advice: with so few unique values (only 2), you can include `strata=[&#39;internetService_DSL&#39;, ...]`
in the call in `.fit`. See documentation in link [E] below.

   Bootstrapping lowess lines. May take a moment...


2. Variable &#39;onlineBackup_Yes&#39; failed the non-proportional test: p-value is &lt;5e-05.

   Advice: with so few unique values (only 2), you can include `strata=[&#39;onlineBackup_Yes&#39;, ...]` in
the call in `.fit`. See documentation in link [E] below.

   Bootstrapping lowess lines. May take a moment...


3. Variable &#39;techSupport_Yes&#39; failed the non-proportional test: p-value is 0.0002.

   Advice: with so few unique values (only 2), you can include `strata=[&#39;techSupport_Yes&#39;, ...]` in
the call in `.fit`. See documentation in link [E] below.

---
[A]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html
[B]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Bin-variable-and-stratify-on-it
[C]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Introduce-time-varying-covariates
[D]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Modify-the-functional-form
[E]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Stratification






[[&lt;Axes: xlabel=&#39;rank-transformed time\n(p=0.3680)&#39;&gt;,
  &lt;Axes: xlabel=&#39;km-transformed time\n(p=0.2232)&#39;&gt;],
 [&lt;Axes: xlabel=&#39;rank-transformed time\n(p=0.0000)&#39;&gt;,
  &lt;Axes: xlabel=&#39;km-transformed time\n(p=0.0000)&#39;&gt;],
 [&lt;Axes: xlabel=&#39;rank-transformed time\n(p=0.0000)&#39;&gt;,
  &lt;Axes: xlabel=&#39;km-transformed time\n(p=0.0000)&#39;&gt;],
 [&lt;Axes: xlabel=&#39;rank-transformed time\n(p=0.0002)&#39;&gt;,
  &lt;Axes: xlabel=&#39;km-transformed time\n(p=0.0044)&#39;&gt;]]
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_27_5.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_27_6.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_27_7.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_27_8.png" alt="png"></p>
<p><em>Method 1: Statistical Test</em></p>
<p>Form the result, we violate the proportional hazard assumption for three of the four variables. And a red flag for this scenario is when we see the survival curves for a given covariate crossover each other when using Kaplan-Meier.</p>
<p><em>Method 2: Schoenfield Residuals</em></p>
<p>假如变量是满足proportional hazard assumption，则图中黑色的实线（变量影响系数随时间的变化）应该平行于蓝色的水平虚线。反之,随着时间的变化，黑色的实线也发生变化。由图可知，’internetService_DSL’,’onlineBackup_Yes’,’techSupport_Yes’不满足proportional hazard assumption。</p>
<p><em>不满足proportional hazard assumption时如何解决？</em></p>
<p>方法一：【分层】对这个不满足proportional hazard assumption的变量进行分层，对剩余的协变量进行cox建模，即根据这个变量分类讨论。h(t|X)&#x3D;h0(t|Z)*partial hazard, Z为分层变量，h0(t|Z)表示在不同分层内的baseline function。<br>代码实现：cph.fit(survival_pd, ‘tenure’, ‘churn’, strata[‘internetService_DSL’,’onlineBackup_Yes’ ,’techSupport_Yes’])</p>
<p>方法二：【时依变量协变量】引入时间与协变量的交互项，允许风险比随时间变化。h(t)&#x3D;h0(t)exp(β1X1+β2X2t+…)，X2t表示协变量X2的影响随时间变化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Method 3: Log-log Kaplan-Meier Plots</span></span><br><span class="line"><span class="comment"># Fit the Kaplan-Meier model</span></span><br><span class="line">kmf = KaplanMeierFitter()</span><br><span class="line">T=telco_pd[<span class="string">&#x27;tenure&#x27;</span>] <span class="comment">#duration</span></span><br><span class="line">C=telco_pd[<span class="string">&#x27;churn&#x27;</span>].astype(<span class="built_in">float</span>) <span class="comment">#event observed</span></span><br><span class="line">kmf.fit(T,C)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Utility function for plotting</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plot_km_loglog</span>(<span class="params">col</span>):</span><br><span class="line">    fig,ax = plt.subplots()</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> telco_pd[col].unique():</span><br><span class="line">        ix = telco_pd[col] == r</span><br><span class="line">        kmf.fit(T[ix], C[ix],label=r)</span><br><span class="line">        kmf.plot_loglogs(ax=ax)</span><br><span class="line">    ax.set_title(<span class="string">f&#x27;Log-log Kaplan-Meier Plots: <span class="subst">&#123;col&#125;</span>&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> encode_cols:</span><br><span class="line">    plot_km_loglog(var)</span><br></pre></td></tr></table></figure>


<p><img src="/2025/04/12/hello-world/lysis-Report/output_29_0.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_29_1.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_29_2.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_29_3.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_29_4.png" alt="png"></p>
<p>When the proportional hazard assumpton is not violated, the Kaplan-Meier curves in the log-log plot will appear parallel.</p>
<h4 id="Model-3：Accelerated-Failure-Time-fully-parametric-model"><a href="#Model-3：Accelerated-Failure-Time-fully-parametric-model" class="headerlink" title="Model 3：Accelerated Failure Time (fully parametric model)"></a>Model 3：Accelerated Failure Time (fully parametric model)</h4><p>assumptions:<br>1.the Proportional Odds assumption</p>
<p>2.the outcome variable is assumed to follow a specified distribution<br><img src="/2025/04/12/hello-world/lysis-Report/97d18aa5-cabe-4736-9526-c05d1e10cc63.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import libraries</span></span><br><span class="line"><span class="keyword">from</span> lifelines <span class="keyword">import</span> WeibullAFTFitter,LogNormalAFTFitter,LogLogisticAFTFitter</span><br><span class="line"><span class="keyword">from</span> lifelines.fitters.coxph_fitter <span class="keyword">import</span> CoxPHFitter</span><br><span class="line"><span class="keyword">from</span> lifelines.statistics <span class="keyword">import</span> proportional_hazard_test</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load the telco silver table</span></span><br><span class="line">telco_pd = silver_df.toPandas()</span><br><span class="line"><span class="comment">#One-Hot Encode the Categorical Variables</span></span><br><span class="line">encode_cols = [<span class="string">&#x27;partner&#x27;</span>,<span class="string">&#x27;multipleLines&#x27;</span>,<span class="string">&#x27;internetService&#x27;</span>,<span class="string">&#x27;onlineSecurity&#x27;</span>, <span class="string">&#x27;onlineBackup&#x27;</span>,<span class="string">&#x27;deviceProtection&#x27;</span>,<span class="string">&#x27;techSupport&#x27;</span>,<span class="string">&#x27;paymentMethod&#x27;</span>]</span><br><span class="line"> </span><br><span class="line">encoded_pd = pd.get_dummies(telco_pd,</span><br><span class="line">               columns=encode_cols,</span><br><span class="line">               prefix=encode_cols,</span><br><span class="line">               drop_first=<span class="literal">False</span>)</span><br><span class="line"> </span><br><span class="line">encoded_pd.head()</span><br></pre></td></tr></table></figure>

<pre><code>25/04/13 13:25:50 WARN CSVHeaderChecker: CSV header does not conform to the schema.
 Header: customerID, gender, SeniorCitizen, Partner, Dependents, tenure, PhoneService, MultipleLines, InternetService, OnlineSecurity, OnlineBackup, DeviceProtection, TechSupport, StreamingTV, StreamingMovies, Contract, PaperlessBilling, PaymentMethod, MonthlyCharges, TotalCharges, Churn
 Schema: customerID, gender, seniorCitizen, partner, dependents, tenure, phoneService, multipleLines, internetService, onlineSecurity, onlineBackup, deviceProtection, techSupport, streamingTV, streamingMovies, contract, paperlessBilling, paymentMethod, monthlyCharges, totalCharges, churnString
Expected: churnString but found: Churn
CSV file: file:///data/lab/homework/project1/Q2_data/Telco-Customer-Churn.csv
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>seniorCitizen</th>
      <th>dependents</th>
      <th>tenure</th>
      <th>phoneService</th>
      <th>streamingTV</th>
      <th>streamingMovies</th>
      <th>contract</th>
      <th>paperlessBilling</th>
      <th>...</th>
      <th>onlineBackup_No</th>
      <th>onlineBackup_Yes</th>
      <th>deviceProtection_No</th>
      <th>deviceProtection_Yes</th>
      <th>techSupport_No</th>
      <th>techSupport_Yes</th>
      <th>paymentMethod_Bank transfer (automatic)</th>
      <th>paymentMethod_Credit card (automatic)</th>
      <th>paymentMethod_Electronic check</th>
      <th>paymentMethod_Mailed check</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7590-VHVEG</td>
      <td>Female</td>
      <td>0.0</td>
      <td>No</td>
      <td>1.0</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>...</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3668-QPYBK</td>
      <td>Male</td>
      <td>0.0</td>
      <td>No</td>
      <td>2.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>...</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9237-HQITU</td>
      <td>Female</td>
      <td>0.0</td>
      <td>No</td>
      <td>2.0</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>...</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9305-CDSKC</td>
      <td>Female</td>
      <td>0.0</td>
      <td>No</td>
      <td>8.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>...</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1452-KIOVK</td>
      <td>Male</td>
      <td>0.0</td>
      <td>Yes</td>
      <td>22.0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>...</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 32 columns</p>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#load data we&#x27;re interested</span></span><br><span class="line">survival_pd = encoded_pd[[<span class="string">&#x27;churn&#x27;</span>,<span class="string">&#x27;tenure&#x27;</span>,<span class="string">&#x27;partner_Yes&#x27;</span>, <span class="string">&#x27;multipleLines_Yes&#x27;</span>, \</span><br><span class="line">                          <span class="string">&#x27;internetService_DSL&#x27;</span>,<span class="string">&#x27;onlineSecurity_Yes&#x27;</span>,<span class="string">&#x27;onlineBackup_Yes&#x27;</span>,<span class="string">&#x27;deviceProtection_Yes&#x27;</span>,<span class="string">&#x27;techSupport_Yes&#x27;</span>,\</span><br><span class="line">                          <span class="string">&#x27;paymentMethod_Bank transfer (automatic)&#x27;</span>,<span class="string">&#x27;paymentMethod_Credit card (automatic)&#x27;</span> ]]</span><br><span class="line"><span class="comment">#Fit the Accelerated Failure Time Model</span></span><br><span class="line"><span class="comment">#（the specified distribution that we have specified for the outcome variable is log-logistic）</span></span><br><span class="line"><span class="comment">#在我们拟合模型并评估结果之后，我们将评估 LogLogistic 是否是为此数据集指定的合适分布类型</span></span><br><span class="line">aft = LogLogisticAFTFitter()</span><br><span class="line">aft.fit(survival_pd, duration_col=<span class="string">&#x27;tenure&#x27;</span>, event_col=<span class="string">&#x27;churn&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note: the output is exponentiated because it is initially in log-odds</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Median Survival Time:&#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(np.exp(aft.median_survival_time_)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#Assess the Results of the Fitted Model</span></span><br><span class="line">aft.print_summary()</span><br><span class="line">aft.plot()</span><br></pre></td></tr></table></figure>

<pre><code>Median Survival Time:135.51
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>model</th>
      <td>lifelines.LogLogisticAFTFitter</td>
    </tr>
    <tr>
      <th>duration col</th>
      <td>'tenure'</td>
    </tr>
    <tr>
      <th>event col</th>
      <td>'churn'</td>
    </tr>
    <tr>
      <th>number of observations</th>
      <td>3351</td>
    </tr>
    <tr>
      <th>number of events observed</th>
      <td>1556</td>
    </tr>
    <tr>
      <th>log-likelihood</th>
      <td>-6838.36</td>
    </tr>
    <tr>
      <th>time fit was run</th>
      <td>2025-04-13 13:25:53 UTC</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th style="min-width: 12px;"></th>
      <th style="min-width: 12px;"></th>
      <th style="min-width: 12px;">coef</th>
      <th style="min-width: 12px;">exp(coef)</th>
      <th style="min-width: 12px;">se(coef)</th>
      <th style="min-width: 12px;">coef lower 95%</th>
      <th style="min-width: 12px;">coef upper 95%</th>
      <th style="min-width: 12px;">exp(coef) lower 95%</th>
      <th style="min-width: 12px;">exp(coef) upper 95%</th>
      <th style="min-width: 12px;">cmp to</th>
      <th style="min-width: 12px;">z</th>
      <th style="min-width: 12px;">p</th>
      <th style="min-width: 12px;">-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="10" valign="top">alpha_</th>
      <th>deviceProtection_Yes</th>
      <td>0.48</td>
      <td>1.62</td>
      <td>0.07</td>
      <td>0.35</td>
      <td>0.62</td>
      <td>1.41</td>
      <td>1.86</td>
      <td>0.00</td>
      <td>6.88</td>
      <td>&lt;0.005</td>
      <td>37.25</td>
    </tr>
    <tr>
      <th>internetService_DSL</th>
      <td>0.38</td>
      <td>1.47</td>
      <td>0.08</td>
      <td>0.23</td>
      <td>0.53</td>
      <td>1.26</td>
      <td>1.71</td>
      <td>0.00</td>
      <td>4.98</td>
      <td>&lt;0.005</td>
      <td>20.59</td>
    </tr>
    <tr>
      <th>multipleLines_Yes</th>
      <td>0.66</td>
      <td>1.94</td>
      <td>0.07</td>
      <td>0.53</td>
      <td>0.80</td>
      <td>1.70</td>
      <td>2.22</td>
      <td>0.00</td>
      <td>9.64</td>
      <td>&lt;0.005</td>
      <td>70.70</td>
    </tr>
    <tr>
      <th>onlineBackup_Yes</th>
      <td>0.81</td>
      <td>2.25</td>
      <td>0.07</td>
      <td>0.68</td>
      <td>0.95</td>
      <td>1.97</td>
      <td>2.59</td>
      <td>0.00</td>
      <td>11.63</td>
      <td>&lt;0.005</td>
      <td>101.50</td>
    </tr>
    <tr>
      <th>onlineSecurity_Yes</th>
      <td>0.86</td>
      <td>2.37</td>
      <td>0.09</td>
      <td>0.69</td>
      <td>1.03</td>
      <td>2.00</td>
      <td>2.80</td>
      <td>0.00</td>
      <td>10.12</td>
      <td>&lt;0.005</td>
      <td>77.60</td>
    </tr>
    <tr>
      <th>partner_Yes</th>
      <td>0.68</td>
      <td>1.97</td>
      <td>0.07</td>
      <td>0.55</td>
      <td>0.81</td>
      <td>1.73</td>
      <td>2.24</td>
      <td>0.00</td>
      <td>10.21</td>
      <td>&lt;0.005</td>
      <td>78.93</td>
    </tr>
    <tr>
      <th>paymentMethod_Bank transfer (automatic)</th>
      <td>0.74</td>
      <td>2.10</td>
      <td>0.09</td>
      <td>0.56</td>
      <td>0.92</td>
      <td>1.75</td>
      <td>2.51</td>
      <td>0.00</td>
      <td>8.05</td>
      <td>&lt;0.005</td>
      <td>50.07</td>
    </tr>
    <tr>
      <th>paymentMethod_Credit card (automatic)</th>
      <td>0.80</td>
      <td>2.22</td>
      <td>0.10</td>
      <td>0.61</td>
      <td>0.99</td>
      <td>1.84</td>
      <td>2.68</td>
      <td>0.00</td>
      <td>8.36</td>
      <td>&lt;0.005</td>
      <td>53.81</td>
    </tr>
    <tr>
      <th>techSupport_Yes</th>
      <td>0.69</td>
      <td>1.99</td>
      <td>0.09</td>
      <td>0.52</td>
      <td>0.86</td>
      <td>1.68</td>
      <td>2.36</td>
      <td>0.00</td>
      <td>7.90</td>
      <td>&lt;0.005</td>
      <td>48.37</td>
    </tr>
    <tr>
      <th>Intercept</th>
      <td>1.59</td>
      <td>4.91</td>
      <td>0.07</td>
      <td>1.46</td>
      <td>1.72</td>
      <td>4.32</td>
      <td>5.58</td>
      <td>0.00</td>
      <td>24.47</td>
      <td>&lt;0.005</td>
      <td>436.88</td>
    </tr>
    <tr>
      <th>beta_</th>
      <th>Intercept</th>
      <td>0.12</td>
      <td>1.13</td>
      <td>0.02</td>
      <td>0.08</td>
      <td>0.16</td>
      <td>1.08</td>
      <td>1.17</td>
      <td>0.00</td>
      <td>5.71</td>
      <td>&lt;0.005</td>
      <td>26.42</td>
    </tr>
  </tbody>
</table><br><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>Concordance</th>
      <td>0.73</td>
    </tr>
    <tr>
      <th>AIC</th>
      <td>13698.72</td>
    </tr>
    <tr>
      <th>log-likelihood ratio test</th>
      <td>877.49 on 9 df</td>
    </tr>
    <tr>
      <th>-log2(p) of ll-ratio test</th>
      <td>605.78</td>
    </tr>
  </tbody>
</table>
</div>





<pre><code>&lt;Axes: xlabel=&#39;log(accelerated failure rate) (95% CI)&#39;&gt;
</code></pre>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_33_3.png" alt="png"></p>
<p>每个所选的变量都显著</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Verify if the Model Adheres to Assumptions</span></span><br><span class="line"><span class="comment"># Fit the Kaplan-Meier model</span></span><br><span class="line"><span class="keyword">from</span> lifelines <span class="keyword">import</span> KaplanMeierFitter</span><br><span class="line">kmf = KaplanMeierFitter()</span><br><span class="line">T=telco_pd[<span class="string">&#x27;tenure&#x27;</span>] <span class="comment">#duration</span></span><br><span class="line">C=telco_pd[<span class="string">&#x27;churn&#x27;</span>].astype(<span class="built_in">float</span>) <span class="comment">#event observed</span></span><br><span class="line">kmf.fit(T,C)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Utility function for plotting</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plot_km_logOdds</span>(<span class="params">col</span>):</span><br><span class="line">    fig,ax = plt.subplots()</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> telco_pd[col].unique():</span><br><span class="line">        ix = telco_pd[col] == r</span><br><span class="line">        kmf.fit(T[ix], C[ix],label=r)</span><br><span class="line">        sf = kmf.survival_function_</span><br><span class="line">        sf[<span class="string">&#x27;failureOdds&#x27;</span>] = (np.log(<span class="number">1</span>-sf))/sf</span><br><span class="line">        sf[<span class="string">&#x27;logTime&#x27;</span>] = np.log(sf.index)</span><br><span class="line">        plt.plot(sf[<span class="string">&#x27;logTime&#x27;</span>],sf[<span class="string">&#x27;failureOdds&#x27;</span>])</span><br><span class="line">        ax.set_title(<span class="string">f&#x27;Log-Odds Kaplan-Meier Plots: <span class="subst">&#123;col&#125;</span>&#x27;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> encode_cols:</span><br><span class="line">    plot_km_logOdds(var)</span><br></pre></td></tr></table></figure>


<p><img src="/2025/04/12/hello-world/lysis-Report/output_35_0.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_35_1.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_35_2.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_35_3.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_35_4.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_35_5.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_35_6.png" alt="png"></p>
<p><img src="/2025/04/12/hello-world/lysis-Report/output_35_7.png" alt="png"></p>
<p>Does the model adhere to the Proportional Odds assumption? - the answer is yes when lines in the plot are parallel.</p>
<p>Is the specified distribution appropriate for this model? - the answer is yes when the lines are straight.</p>
<h4 id="应用：Customer-Lifetime-Value"><a href="#应用：Customer-Lifetime-Value" class="headerlink" title="应用：Customer Lifetime Value"></a>应用：Customer Lifetime Value</h4><p>虽然一些变量不满足proportional hazard assumption，但当我们使用Cox Proportional Hazard model进行预测时，可以不关心proportional hazard assumption。</p>
<p>参考文献：<a target="_blank" rel="noopener" href="https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Do-I-need-to-care-about-the-proportional-hazard-assumption">https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Do-I-need-to-care-about-the-proportional-hazard-assumption</a>?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#（重复前面的步骤）Fit a Cox Proportional Hazard model</span></span><br><span class="line">telco_pd = silver_df.toPandas()</span><br><span class="line"><span class="comment"># Encode columns of interest</span></span><br><span class="line">encode_cols = [<span class="string">&#x27;dependents&#x27;</span>,<span class="string">&#x27;internetService&#x27;</span>,<span class="string">&#x27;onlineBackup&#x27;</span>,<span class="string">&#x27;techSupport&#x27;</span>,<span class="string">&#x27;paperlessBilling&#x27;</span>]</span><br><span class="line"> </span><br><span class="line">encoded_pd = pd.get_dummies(telco_pd,</span><br><span class="line">               columns=encode_cols,</span><br><span class="line">               prefix=encode_cols,</span><br><span class="line">               drop_first=<span class="literal">False</span>)</span><br><span class="line"> </span><br><span class="line">encoded_pd.head()</span><br><span class="line"><span class="comment"># Create new dataframe consisting of only the variables needed to fit the model</span></span><br><span class="line">survival_pd = encoded_pd[[<span class="string">&#x27;churn&#x27;</span>,<span class="string">&#x27;tenure&#x27;</span>,<span class="string">&#x27;dependents_Yes&#x27;</span>,<span class="string">&#x27;internetService_DSL&#x27;</span>,<span class="string">&#x27;onlineBackup_Yes&#x27;</span>,<span class="string">&#x27;techSupport_Yes&#x27;</span>]]</span><br><span class="line"><span class="comment"># Cast churn column as a float</span></span><br><span class="line">survival_pd.loc[:,<span class="string">&#x27;churn&#x27;</span>] = survival_pd.loc[:,<span class="string">&#x27;churn&#x27;</span>].astype(<span class="string">&#x27;float&#x27;</span>)</span><br><span class="line">cph = CoxPHFitter(alpha=<span class="number">0.05</span>)</span><br><span class="line">cph.fit(survival_pd, <span class="string">&#x27;tenure&#x27;</span>, <span class="string">&#x27;churn&#x27;</span>)</span><br></pre></td></tr></table></figure>

<pre><code>25/04/13 13:26:06 WARN CSVHeaderChecker: CSV header does not conform to the schema.
 Header: customerID, gender, SeniorCitizen, Partner, Dependents, tenure, PhoneService, MultipleLines, InternetService, OnlineSecurity, OnlineBackup, DeviceProtection, TechSupport, StreamingTV, StreamingMovies, Contract, PaperlessBilling, PaymentMethod, MonthlyCharges, TotalCharges, Churn
 Schema: customerID, gender, seniorCitizen, partner, dependents, tenure, phoneService, multipleLines, internetService, onlineSecurity, onlineBackup, deviceProtection, techSupport, streamingTV, streamingMovies, contract, paperlessBilling, paymentMethod, monthlyCharges, totalCharges, churnString
Expected: churnString but found: Churn
CSV file: file:///data/lab/homework/project1/Q2_data/Telco-Customer-Churn.csv
/usr/local/lib/python3.10/dist-packages/lifelines/utils/__init__.py:1187: UserWarning: Attempting to convert an unexpected datatype &#39;object&#39; to float. Suggestion: 1) use `lifelines.utils.datetimes_to_durations` to do conversions or 2) manually convert to floats/booleans.
  warnings.warn(warning_text, UserWarning)





&lt;lifelines.CoxPHFitter: fitted with 3351 total observations, 1795 right-censored observations&gt;
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入库</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> ipywidgets <span class="keyword">as</span> widgets</span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> display</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 1: 创建交互式小部件</span></span><br><span class="line">cols = [<span class="string">&#x27;dependents_Yes&#x27;</span>, <span class="string">&#x27;internetService_DSL&#x27;</span>, <span class="string">&#x27;onlineBackup_Yes&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;techSupport_Yes&#x27;</span>, <span class="string">&#x27;partner_Yes&#x27;</span>, <span class="string">&#x27;internal_rate_of_return&#x27;</span>]</span><br><span class="line"></span><br><span class="line">widget_dict = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> cols:</span><br><span class="line">    <span class="keyword">if</span> col == <span class="string">&#x27;internal_rate_of_return&#x27;</span>:</span><br><span class="line">        widget_dict[col] = widgets.FloatText(value=<span class="number">0.10</span>, description=col)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        widget_dict[col] = widgets.Dropdown(options=[<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>], value=<span class="string">&#x27;0&#x27;</span>, description=col)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有小部件</span></span><br><span class="line">display(widgets.VBox(<span class="built_in">list</span>(widget_dict.values())))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2: 获取小部件值并构建数据帧</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_widget_values</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从交互式小部件中获取值并返回一个DataFrame&quot;&quot;&quot;</span></span><br><span class="line">    values = &#123;col: widget.value <span class="keyword">for</span> col, widget <span class="keyword">in</span> widget_dict.items()&#125;</span><br><span class="line">    <span class="keyword">return</span> pd.DataFrame([values])</span><br></pre></td></tr></table></figure>


<pre><code>VBox(children=(Dropdown(description=&#39;dependents_Yes&#39;, options=(&#39;0&#39;, &#39;1&#39;), value=&#39;0&#39;), Dropdown(description=&#39;in…
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试获取小部件值</span></span><br><span class="line">df = get_widget_values()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;用户输入的数据帧：&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(df) </span><br></pre></td></tr></table></figure>

<pre><code>用户输入的数据帧：
  dependents_Yes internetService_DSL onlineBackup_Yes techSupport_Yes  \
0              1                   0                0               1   

  partner_Yes  internal_rate_of_return  
0           0                      0.6  
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Step 3: 生存分析相关计算</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_payback_df</span>(<span class="params">df</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;基于输入数据计算生存分析相关指标&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内部收益率（IRR）</span></span><br><span class="line">    irr = df[<span class="string">&#x27;internal_rate_of_return&#x27;</span>].astype(<span class="built_in">float</span>).values[<span class="number">0</span>] / <span class="number">12</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment"># 预测生存概率</span></span><br><span class="line">    survival_df = cph.predict_survival_function(df,times=np.arange(<span class="number">1</span>,<span class="number">37</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构建结果数据帧</span></span><br><span class="line">    cohort_df = pd.concat([</span><br><span class="line">        pd.DataFrame([<span class="number">1.00</span>]),  <span class="comment"># 初始值</span></span><br><span class="line">        <span class="built_in">round</span>(survival_df, <span class="number">2</span>)</span><br><span class="line">    ]).rename(columns=&#123;<span class="number">0</span>: <span class="string">&#x27;Survival Probability&#x27;</span>&#125;)</span><br><span class="line">    cohort_df[<span class="string">&#x27;Contract Month&#x27;</span>] = cohort_df.index.astype(<span class="string">&#x27;int&#x27;</span>)</span><br><span class="line">    cohort_df[<span class="string">&#x27;Monthly Profit for the Selected Plan&#x27;</span>] = <span class="number">30</span></span><br><span class="line">    cohort_df[<span class="string">&#x27;Avg Expected Monthly Profit&#x27;</span>] = <span class="built_in">round</span>(</span><br><span class="line">        cohort_df[<span class="string">&#x27;Survival Probability&#x27;</span>] * cohort_df[<span class="string">&#x27;Monthly Profit for the Selected Plan&#x27;</span>], <span class="number">2</span></span><br><span class="line">    )</span><br><span class="line">    cohort_df[<span class="string">&#x27;NPV of Avg Expected Monthly Profit&#x27;</span>] = <span class="built_in">round</span>(</span><br><span class="line">        cohort_df[<span class="string">&#x27;Avg Expected Monthly Profit&#x27;</span>] / ((<span class="number">1</span> + irr) ** cohort_df[<span class="string">&#x27;Contract Month&#x27;</span>]), <span class="number">2</span></span><br><span class="line">    )</span><br><span class="line">    cohort_df[<span class="string">&#x27;Cumulative NPV&#x27;</span>] = cohort_df[<span class="string">&#x27;NPV of Avg Expected Monthly Profit&#x27;</span>].cumsum()</span><br><span class="line">    cohort_df[<span class="string">&#x27;Contract Month&#x27;</span>] = cohort_df[<span class="string">&#x27;Contract Month&#x27;</span>]+<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回最终结果</span></span><br><span class="line">    <span class="keyword">return</span> cohort_df[[<span class="string">&#x27;Contract Month&#x27;</span>, <span class="string">&#x27;Survival Probability&#x27;</span>, <span class="string">&#x27;Monthly Profit for the Selected Plan&#x27;</span>, </span><br><span class="line">                      <span class="string">&#x27;Avg Expected Monthly Profit&#x27;</span>, <span class="string">&#x27;NPV of Avg Expected Monthly Profit&#x27;</span>, <span class="string">&#x27;Cumulative NPV&#x27;</span>]].set_index(<span class="string">&#x27;Contract Month&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试计算函数</span></span><br><span class="line">payback_df = calculate_payback_df(df)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n计算结果：&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(payback_df.head())</span><br></pre></td></tr></table></figure>

<pre><code>计算结果：
                Survival Probability  Monthly Profit for the Selected Plan  \
Contract Month                                                               
1                               1.00                                    30   
2                               0.95                                    30   
3                               0.92                                    30   
4                               0.91                                    30   
5                               0.89                                    30   

                Avg Expected Monthly Profit  \
Contract Month                                
1                                      30.0   
2                                      28.5   
3                                      27.6   
4                                      27.3   
5                                      26.7   

                NPV of Avg Expected Monthly Profit  Cumulative NPV  
Contract Month                                                      
1                                            30.00           30.00  
2                                            27.14           57.14  
3                                            25.03           82.17  
4                                            23.58          105.75  
5                                            21.97          127.72  
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Step 4: 可视化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plot_results</span>(<span class="params">payback_df</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;绘制条形图和折线图&quot;&quot;&quot;</span></span><br><span class="line">    plt.figure(figsize=(<span class="number">12</span>, <span class="number">6</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 条形图：累计净现值</span></span><br><span class="line">    plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">    sns.barplot(x=[<span class="string">&#x27;12 Months&#x27;</span>, <span class="string">&#x27;24 Months&#x27;</span>, <span class="string">&#x27;36 Months&#x27;</span>], </span><br><span class="line">                y=payback_df.iloc[[<span class="number">11</span>, <span class="number">23</span>, <span class="number">35</span>], :][<span class="string">&#x27;Cumulative NPV&#x27;</span>])</span><br><span class="line">    plt.title(<span class="string">&#x27;Cumulative NPV Over Time&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Time Period&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Cumulative NPV&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 折线图：生存概率</span></span><br><span class="line">    plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">    sns.lineplot(x=payback_df.index, y=payback_df[<span class="string">&#x27;Survival Probability&#x27;</span>])</span><br><span class="line">    plt.title(<span class="string">&#x27;Survival Probability Over Time&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Contract Month&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Survival Probability&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    plt.tight_layout()</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制图表</span></span><br><span class="line">plot_results(payback_df)</span><br></pre></td></tr></table></figure>


<p><img src="/2025/04/12/hello-world/lysis-Report/output_42_0.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark.stop()</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/04/13/Survival-Analysis-Report/" data-id="cm9fx5lgh0000dwueeo7gg7fe" data-title="Survival_Analysis_Report" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2025/04/12/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">April 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/04/13/Survival-Analysis-Report/">Survival_Analysis_Report</a>
          </li>
        
          <li>
            <a href="/2025/04/12/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 ylinJiang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>